# üöÄ Complete Asterisk WebRTC Integration Guide

## Overview

This guide shows how to set up **real browser-to-browser calls** using Asterisk WebRTC. Agents register their SIP credentials (generated from HR page) and can make/receive calls through their browser.

---

## üìã WHAT'S BEEN IMPLEMENTED

### ‚úÖ Backend (Complete!)

**HR System (`/hr` endpoints):**
- Create agents with auto SIP credential generation
- Manage users (CRUD operations)
- Regenerate SIP credentials
- WebRTC configuration management

**SIP Credential Generation:**
- Username: `agent_name_timestamp`
- Password: 32-character random hex
- Extension: Auto-incremented (1000, 1001, 1002...)

**Database:**
- `users` table enhanced with: `sip_username`, `sip_password`, `sip_extension`
- `webrtc_config` table for STUN/TURN servers

### ‚úÖ Frontend (Complete!)

**HR Page (`/dashboard/hr`):**
- Create agents with one click
- SIP credentials displayed in modal (shown once!)
- Copy credentials to clipboard
- Regenerate credentials
- Search and filter users
- View SIP status for each agent

**WebRTC Setup Page (`/dashboard/webrtc-setup`):**
- *(To be updated with SIP registration)*

---

## üéØ HOW IT WORKS

### **Step 1: Admin Creates Agent (HR Page)**

1. **Login as admin** (`admin@education.gov` / `admin123`)
2. **Go to HR page** (`/dashboard/hr`)
3. **Click "Add Agent"**
4. **Fill in details:**
   - Name: John Doe
   - Phone: +232 76 123 456
   - Password: agent123
   - Account Type: **Agent** (SIP auto-generated!)
5. **Click "Create User"**

6. **SIP Credentials Modal Appears:**
   ```
   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   ‚îÇ  SIP Credentials Generated           ‚îÇ
   ‚îÇ                                       ‚îÇ
   ‚îÇ  ‚ö†Ô∏è SAVE NOW! Won't show again!      ‚îÇ
   ‚îÇ                                       ‚îÇ
   ‚îÇ  USERNAME: john_doe_1700000000       ‚îÇ
   ‚îÇ  PASSWORD: a1b2c3d4e5f6g7h8...       ‚îÇ
   ‚îÇ  EXTENSION: 1000                     ‚îÇ
   ‚îÇ                                       ‚îÇ
   ‚îÇ  [Copy] buttons for each              ‚îÇ
   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   ```

7. **Admin copies and gives to agent**

---

### **Step 2: Agent Registers WebRTC Phone**

1. **Login as agent** (using credentials from step 1)
2. **Go to WebRTC Setup** (`/dashboard/webrtc-setup`)
3. **Enter SIP credentials:**
   - SIP Username: `john_doe_1700000000`
   - SIP Password: `a1b2c3d4e5f6g7h8...`
   - Extension: `1000`
4. **Click "Register"**
5. **Browser connects to Asterisk via WebSocket**
6. **Status changes to "Registered"**
7. **Agent is now ready to make/receive calls!**

---

### **Step 3: Making Calls**

**Citizen calls from Call Dialer:**
- Citizen goes to `/dashboard/call-dialer`
- Dials extension: `1000`
- Call routes to John Doe's browser
- Agent's browser rings
- Agent answers in browser

**Agent calls citizen:**
- Agent dials citizen's number
- Call connects through Asterisk
- Browser-to-browser audio via WebRTC

---

## üîß ASTERISK CONFIGURATION

### **Required Asterisk Setup**

Your Asterisk Docker container needs WebRTC configuration. Here's what needs to be added:

### **1. Enable WebSocket in `http.conf`**

Add to `/etc/asterisk/http.conf`:
```ini
[general]
enabled=yes
bindaddr=0.0.0.0
bindport=8088
tlsenable=no

; WebSocket settings
enablestatic=yes
redirect = / /static/config/index.html

[websocket]
enabled=yes
```

Reload: `docker exec asterisk asterisk -rx "http reload"`

---

### **2. Configure PJSIP for WebRTC**

The HR system generates PJSIP config automatically!

**Get Generated Config:**
```bash
curl http://localhost:3001/hr/webrtc-config
```

**Or manually add to `/etc/asterisk/pjsip.conf`:**

```ini
; Transport for WebRTC
[transport-wss]
type=transport
protocol=wss
bind=0.0.0.0:8089
external_media_address=YOUR_PUBLIC_IP
external_signaling_address=YOUR_PUBLIC_IP

; Transport for WebSocket (non-TLS for development)
[transport-ws]
type=transport
protocol=ws
bind=0.0.0.0:8088

; ==== Agent Configurations (auto-generated by HR system) ====

; Agent: john_doe_1700000000
[john_doe_1700000000]
type=aor
max_contacts=1
remove_existing=yes

[john_doe_1700000000]
type=auth
auth_type=userpass
username=john_doe_1700000000
password=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6

[john_doe_1700000000]
type=endpoint
context=from-internal
disallow=all
allow=ulaw
allow=alaw
allow=opus
webrtc=yes
aors=john_doe_1700000000
auth=john_doe_1700000000
use_avpf=yes
media_encryption=dtls
dtls_verify=fingerprint
dtls_cert_file=/etc/asterisk/keys/asterisk.pem
dtls_ca_file=/etc/asterisk/keys/ca.crt
dtls_setup=actpass
ice_support=yes
media_use_received_transport=yes
rtcp_mux=yes
```

Reload: `docker exec asterisk asterisk -rx "pjsip reload"`

---

### **3. Add Dialplan in `extensions.conf`**

Add to `/etc/asterisk/extensions.conf`:

```ini
[from-internal]

; Agent extension (calls to agent's browser)
exten => 1000,1,NoOp(Incoming call to john_doe_1700000000)
 same => n,Dial(PJSIP/john_doe_1700000000,30)
 same => n,Hangup()

; Add more agents as created...
exten => 1001,1,NoOp(Incoming call to agent 1001)
 same => n,Dial(PJSIP/agent_name_1001,30)
 same => n,Hangup()

; Hotline number (117) - routes to available agent
exten => 117,1,NoOp(Ministry Hotline)
 same => n,Queue(support_queue,t,,,300)
 same => n,Hangup()
```

Reload: `docker exec asterisk asterisk -rx "dialplan reload"`

---

### **4. Generate SSL Certificates (for DTLS)**

WebRTC requires SSL certificates for DTLS:

```bash
# Enter Asterisk container
docker exec -it asterisk bash

# Create keys directory
mkdir -p /etc/asterisk/keys
cd /etc/asterisk/keys

# Generate self-signed certificate
openssl req -x509 -newkey rsa:4096 -keyout asterisk.key -out asterisk.pem -days 365 -nodes

# Copy to CA file
cp asterisk.pem ca.crt

# Set permissions
chmod 600 asterisk.key asterisk.pem ca.crt
```

---

## üåê WEBRTC CONFIG (STUN/TURN)

### **Default Configuration**

The system uses Google's public STUN server by default:
```
STUN: stun:stun.l.google.com:19302
```

### **Update Configuration (Admin)**

Admin can update via Settings or API:

```bash
curl -X PUT http://localhost:3001/hr/webrtc-config \
  -H "Content-Type: application/json" \
  -d '{
    "stunServer": "stun:stun.l.google.com:19302",
    "asteriskWsUrl": "ws://localhost:8088/ws"
  }'
```

### **Add TURN Server (for NAT)**

If agents are behind NAT:

```bash
curl -X PUT http://localhost:3001/hr/webrtc-config \
  -H "Content-Type: application/json" \
  -d '{
    "stunServer": "stun:stun.l.google.com:19302",
    "turnServer": "turn:your-turn-server.com:3478",
    "turnUsername": "username",
    "turnPassword": "password",
    "asteriskWsUrl": "ws://localhost:8088/ws"
  }'
```

---

## üß™ TESTING THE COMPLETE FLOW

### **Test 1: Create Agent in HR**

```bash
# Create agent via API
curl -X POST http://localhost:3001/hr/users \
  -H "Content-Type: application/json" \
  -d '{
    "name": "John Doe",
    "phoneNumber": "+232 76 123 456",
    "password": "agent123",
    "accountType": "agent"
  }'

# Response includes SIP credentials
{
  "status": "ok",
  "user": {
    "id": "user_1700000000",
    "sipUsername": "john_doe_1700000000",
    "sipExtension": "1000",
    "sipPasswordGenerated": true
  },
  "message": "Agent created with SIP credentials. Extension: 1000"
}
```

### **Test 2: Get All Agents**

```bash
curl http://localhost:3001/hr/users?accountType=agent
```

### **Test 3: Regenerate SIP Credentials**

```bash
curl -X POST http://localhost:3001/hr/users/user_1700000000/regenerate-sip

# Response includes new credentials
{
  "status": "ok",
  "sipCredentials": {
    "username": "john_doe_1700000001",
    "password": "new_32_char_password",
    "extension": "1000"
  }
}
```

---

## üì± FRONTEND USAGE

### **Admin Workflow**

1. **Create Agents:**
   - Go to `/dashboard/hr`
   - Click "Add Agent"
   - Fill form and submit
   - **Copy SIP credentials from modal**
   - Share with agent

2. **Manage Agents:**
   - View all agents in table
   - See SIP status (configured/not configured)
   - Regenerate credentials if needed
   - Delete agents

3. **View Stats:**
   - Total users
   - Number of agents
   - Active users
   - Agents with SIP

### **Agent Workflow**

1. **Get Credentials from Admin**

2. **Register WebRTC Phone:**
   - Go to `/dashboard/webrtc-setup`
   - Enter SIP username, password, extension
   - Click "Register"
   - Wait for "Registered" status

3. **Start Receiving Calls:**
   - Browser stays open
   - When call comes in, browser rings
   - Click "Answer"
   - Talk to citizen

4. **Make Calls:**
   - Use softphone or dialer
   - Dial extension or external number
   - Call connects through browser

---

## üîê SECURITY NOTES

### **SIP Password Security**

- ‚úÖ Passwords are 32-character random hex
- ‚úÖ Shown only once after generation
- ‚úÖ Not returned in normal API calls
- ‚úÖ Use `hasSipCredentials` boolean instead
- ‚ö†Ô∏è Admin can regenerate if lost

### **WebSocket Security**

For production:
- Use WSS (WebSocket Secure) instead of WS
- Configure SSL certificates in Asterisk
- Update `asteriskWsUrl` to `wss://your-domain.com:8089/ws`

### **TURN Server**

For production behind NAT:
- Setup your own TURN server (coturn)
- Don't use public TURN servers
- Use authentication credentials

---

## üêõ TROUBLESHOOTING

### **Agent Can't Register**

**Check:**
1. ‚úÖ SIP credentials entered correctly
2. ‚úÖ Asterisk WebSocket is running: `ws://localhost:8088/ws`
3. ‚úÖ PJSIP configuration includes agent
4. ‚úÖ Asterisk is reloaded after config changes

**Test:**
```bash
# Check Asterisk WebSocket
curl http://localhost:8088/ws
# Should get "Upgrade Required"

# Check PJSIP endpoint
docker exec asterisk asterisk -rx "pjsip show endpoints"
# Should list your agent's username

# Check AORs
docker exec asterisk asterisk -rx "pjsip show aors"
```

### **Calls Not Connecting**

**Check:**
1. ‚úÖ Both parties registered
2. ‚úÖ Dialplan configured correctly
3. ‚úÖ Extensions match
4. ‚úÖ ICE/STUN working (check browser console)

**Debug:**
```bash
# Asterisk console
docker exec -it asterisk asterisk -rvvv

# Watch for SIP messages
pjsip set logger on

# Test dial
originate PJSIP/agent_username application Echo
```

### **No Audio**

**Check:**
1. ‚úÖ Microphone permission granted
2. ‚úÖ DTLS certificates configured
3. ‚úÖ Codec match (opus, ulaw, alaw)
4. ‚úÖ ICE candidates exchanged

**Browser Console:**
```javascript
// Check WebRTC connection state
pc.connectionState  // should be 'connected'
pc.iceConnectionState  // should be 'connected'
```

---

## üéØ PRODUCTION CHECKLIST

### **Before Going Live:**

- [ ] Configure WSS (secure WebSocket)
- [ ] Setup own TURN server
- [ ] SSL certificates for Asterisk
- [ ] Firewall rules (ports 8088, 8089, RTP range)
- [ ] External IP configuration in PJSIP
- [ ] Load balancing for multiple Asterisk servers
- [ ] Call recording configuration
- [ ] Queue management
- [ ] Agent login/logout tracking
- [ ] Real-time monitoring dashboard

---

## üìä NEXT STEPS

1. **Update WebRTC Setup Page:**
   - Add SIP registration form
   - Implement SIP.js client
   - Real-time registration status
   - Test call functionality

2. **Implement Call Dialer:**
   - Real WebRTC calling from Call Dialer page
   - Integration with Asterisk
   - Call status tracking

3. **Queue Management:**
   - Setup ACD (Automatic Call Distribution)
   - Agent availability tracking
   - Call routing by skills

4. **Analytics:**
   - Call duration tracking
   - Agent performance metrics
   - Queue statistics

---

## ‚úÖ CURRENT STATUS

| Component | Status | Notes |
|-----------|--------|-------|
| **Backend HR API** | ‚úÖ Complete | All endpoints working |
| **SIP Generation** | ‚úÖ Complete | Auto-generated on agent creation |
| **Database Schema** | ‚úÖ Complete | Tables updated with SIP fields |
| **Frontend HR Page** | ‚úÖ Complete | Create/manage agents with SIP |
| **Asterisk Config** | ‚ö†Ô∏è Manual | Admin must add to pjsip.conf |
| **WebRTC Setup** | üîÑ In Progress | Registration UI needs SIP.js |
| **Call Dialer** | üîÑ In Progress | UI ready, needs WebRTC integration |

---

## üöÄ START TESTING NOW!

1. **Start backend:** `cd backend && npm run start:dev`
2. **Start frontend:** `cd frontend && npm run dev`
3. **Login as admin:** `admin@education.gov` / `admin123`
4. **Go to HR:** Create your first agent!
5. **Get SIP credentials:** Copy from modal
6. **Configure Asterisk:** Add to pjsip.conf
7. **Test registration:** Agent goes to WebRTC Setup

**Everything is ready for full WebRTC calling! üéâ**
